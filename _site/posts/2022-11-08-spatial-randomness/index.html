<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Josiah Parry">
<meta name="dcterms.date" content="2022-11-08">

<title>Josiah Parry - Complete spatial randomness</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta name="twitter:title" content="Josiah Parry - Complete spatial randomness">
<meta name="twitter:description" content="< this is a cliche about Tobler’s fist law and things being related in space>. Because of Tobler’s first law, spatial data tend to not follow any specific distribution.">
<meta name="twitter:creator" content="@josiahparry">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Complete spatial randomness</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Josiah Parry</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">home</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../about.html" class="sidebar-item-text sidebar-link">about</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/index.html" class="sidebar-item-text sidebar-link">posts</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects.html" class="sidebar-item-text sidebar-link">projects</a>
  </div>
</li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#bootstrap-sampling" id="toc-bootstrap-sampling" class="nav-link active" data-scroll-target="#bootstrap-sampling">Bootstrap sampling</a></li>
  <li><a href="#bootstrap-simulations" id="toc-bootstrap-simulations" class="nav-link" data-scroll-target="#bootstrap-simulations">Bootstrap simulations</a>
  <ul class="collapse">
  <li><a href="#bootstrap-limitations" id="toc-bootstrap-limitations" class="nav-link" data-scroll-target="#bootstrap-limitations">Bootstrap limitations</a></li>
  </ul></li>
  <li><a href="#conditional-permutation" id="toc-conditional-permutation" class="nav-link" data-scroll-target="#conditional-permutation">Conditional Permutation</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Complete spatial randomness</h1>
  <div class="quarto-categories">
    <div class="quarto-category">spatial</div>
    <div class="quarto-category">rstats</div>
    <div class="quarto-category">sfdep</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Josiah Parry </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 8, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>&lt; this is a cliche about Tobler’s fist law and things being related in space&gt;. Because of Tobler’s first law, spatial data tend to not follow any specific distribution. So, p-values are sort of…not all that accurate most of the time. P-values in spatial statistics often take a “non-parametric” approach instead of an “analytical” one.</p>
<p>Consider the t-test. T-tests make the assumption that data are coming from a normal distribution. Then p-values are derived from the cumulative distribution function. The alternative hypothesis, then, is that the true difference in means is not 0.</p>
<p>In the spatial case, our alternative hypothesis is generally “the observed statistic different than what we would expect under complete spatial randomness?” But what really does that mean? To know, we have to simulate spatial randomness.</p>
<p>There are two approaches to simulating spatial randomness that I’ll go over. One is better than the other. First, I’m going to describe the less good one: bootstrap sampling.</p>
<p>Load the super duper cool packages. We create queen contiguity neighbors and row-standardized weights.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="kr"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="o">(</span><span class="nv"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="o">)</span>
<span class="kr"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="o">(</span><span class="nv"><a href="https://sfdep.josiahparry.com">sfdep</a></span><span class="o">)</span>
<span class="kr"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="o">(</span><span class="nv"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="o">)</span>

<span class="nv">grid</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">st_make_grid</a></span><span class="o">(</span>cellsize <span class="o">=</span> <span class="nf"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="o">(</span><span class="m">1</span>, <span class="m">1</span><span class="o">)</span>, n <span class="o">=</span> <span class="m">12</span>, offset <span class="o">=</span> <span class="nf"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="o">(</span><span class="m">0</span>, <span class="m">0</span><span class="o">)</span><span class="o">)</span> |&gt; 
  <span class="nf"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="o">(</span><span class="o">)</span> |&gt; 
  <span class="nf"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="o">(</span><span class="o">)</span> |&gt; 
  <span class="nf"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="o">(</span>
    id <span class="o">=</span> <span class="nf"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="o">(</span><span class="o">)</span>,
    nb <span class="o">=</span> <span class="nf"><a href="https://sfdep.josiahparry.com/reference/st_contiguity.html">st_contiguity</a></span><span class="o">(</span><span class="nv">geometry</span><span class="o">)</span>,
    wt <span class="o">=</span> <span class="nf"><a href="https://sfdep.josiahparry.com/reference/st_weights.html">st_weights</a></span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span>
    <span class="o">)</span></code></pre>
</div>
<p>Let’s generate some spatially autocorrelated data. This function is a little slow, but it works.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">nb</span> <span class="o">&lt;-</span> <span class="nv">grid</span><span class="o">[[</span><span class="s">"nb"</span><span class="o">]</span><span class="o">]</span>
<span class="nv">wt</span> <span class="o">&lt;-</span> <span class="nv">grid</span><span class="o">[[</span><span class="s">"wt"</span><span class="o">]</span><span class="o">]</span>

<span class="nv">x</span> <span class="o">&lt;-</span>  <span class="nf">geostan</span><span class="nf">::</span><span class="nf"><a href="https://connordonegan.github.io/geostan/reference/sim_sar.html">sim_sar</a></span><span class="o">(</span>w <span class="o">=</span> <span class="nf"><a href="https://sfdep.josiahparry.com/reference/wt_as_matrix.html">wt_as_matrix</a></span><span class="o">(</span><span class="nv">nb</span>, <span class="nv">wt</span><span class="o">)</span>, rho <span class="o">=</span> <span class="m">0.78</span><span class="o">)</span></code></pre>
</div>
<section id="bootstrap-sampling" class="level2">
<h2 class="anchored" data-anchor-id="bootstrap-sampling">Bootstrap sampling</h2>
<p>Under the bootstrap approach we are sampling from existing spatial configurations. In our case there are 144 existing neighborhoods. For our simulations, we will randomly sample from existing neighborhoods and then recalculate our statistic. It helps us by imposing randomness into our statistic. We can then repeat the process <code>nsim</code> times. There is a limitation, however. It is that there are only <code>n - 1</code> possible neighborhood configurations per location.</p>
<p>Here we visualize a random point and it’s neighbors.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r">
<span class="c"># for a given location create vector indicating position of</span>
<span class="c"># neighbors and self</span>
<span class="nv">color_block</span> <span class="o">&lt;-</span> <span class="kr">function</span><span class="o">(</span><span class="nv">i</span>, <span class="nv">nb</span><span class="o">)</span> <span class="o">{</span>
  <span class="nv">res</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="o">(</span><span class="m">1</span><span class="o">:</span><span class="nf"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span> <span class="o"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="nv">nb</span><span class="o">[[</span><span class="nv">i</span><span class="o">]</span><span class="o">]</span>, <span class="s">"neighbors"</span>, <span class="kc">NA</span><span class="o">)</span>
  <span class="nv">res</span><span class="o">[</span><span class="nv">i</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="s">"self"</span>
  <span class="nv">res</span>
<span class="o">}</span></code></pre>
</div>
<p>Plot a point and its neighbors</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">grid</span> |&gt; 
  <span class="nf"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="o">(</span>block <span class="o">=</span> <span class="nf">color_block</span><span class="o">(</span><span class="nf"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="o">(</span><span class="m">1</span><span class="o">:</span><span class="nf"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="o">(</span><span class="o">)</span>, <span class="m">1</span><span class="o">)</span>, <span class="nv">nb</span><span class="o">)</span><span class="o">)</span> |&gt; 
  <span class="nf"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="o">(</span><span class="nf"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="o">(</span>fill <span class="o">=</span> <span class="nv">block</span><span class="o">)</span><span class="o">)</span> <span class="o">+</span>
  <span class="nf"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="o">(</span><span class="o">)</span> <span class="o">+</span>
  <span class="nf"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="o">(</span>title <span class="o">=</span> <span class="s">"Point and it's neighbors"</span><span class="o">)</span>
</code></pre>
<p><img src="figs/unnamed-chunk-4-1.png" width="700px" style="display: block; margin: auto;"></p>
</div>
<p>For bootstrap we grab a point and then the neighbors from another point. This function will randomize a <code>nb</code> list object.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">color_sample_block</span> <span class="o">&lt;-</span> <span class="kr">function</span><span class="o">(</span><span class="nv">i</span>, <span class="nv">nb</span><span class="o">)</span> <span class="o">{</span>
  <span class="nv">index</span> <span class="o">&lt;-</span> <span class="m">1</span><span class="o">:</span><span class="nf"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span>
  <span class="nv">not_i</span> <span class="o">&lt;-</span> <span class="nv">index</span><span class="o">[</span><span class="o">-</span><span class="nv">i</span><span class="o">]</span>
  
  <span class="nv">sample_block_focal</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="o">(</span><span class="nv">not_i</span>, <span class="m">1</span><span class="o">)</span>
  
  <span class="nv">res</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="o">(</span><span class="kc">NA</span>, <span class="nf"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="o">(</span><span class="nv">index</span><span class="o">)</span><span class="o">)</span>
  
  <span class="nv">res</span><span class="o">[</span><span class="nv">nb</span><span class="o">[[</span><span class="nv">sample_block_focal</span><span class="o">]</span><span class="o">]</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="s">"neighbors"</span>
  <span class="nv">res</span><span class="o">[</span><span class="nv">i</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="s">"self"</span>
  <span class="nv">res</span>
<span class="o">}</span>

<span class="c"># visualize it</span>
<span class="nv">grid</span> |&gt; 
  <span class="nf"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="o">(</span>block <span class="o">=</span> <span class="nf">color_sample_block</span><span class="o">(</span><span class="nf"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="o">(</span><span class="m">1</span><span class="o">:</span><span class="nf"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="o">(</span><span class="o">)</span>, <span class="m">1</span><span class="o">)</span>, <span class="nv">nb</span><span class="o">)</span><span class="o">)</span> |&gt; 
  <span class="nf"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="o">(</span><span class="nf"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="o">(</span>fill <span class="o">=</span> <span class="nv">block</span><span class="o">)</span><span class="o">)</span> <span class="o">+</span>
  <span class="nf"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="o">(</span><span class="o">)</span> <span class="o">+</span>
  <span class="nf"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="o">(</span>title <span class="o">=</span> <span class="s">"Point and random point's neighbors"</span><span class="o">)</span>
</code></pre>
<p><img src="figs/unnamed-chunk-5-1.png" width="700px" style="display: block; margin: auto;"></p>
</div>
<p>Often, we will want to create a reference distribution by creating a large number of simulations—typically 999. As the simulations increase in size, we are limited in the amount of samples we can draw. The number of neighborhoods becomes limiting!</p>
<p>Say we want to look at income distribution in Boston and the only data we have is at the census tract level. I happen to know that Boston has 207 tracts. If we want to do 999 simulations, after the 206th simulation, we will likely have gone through all over the neighborhood configurations!</p>
<p>How can we do this sampling? For each observation, we can sample another location, grab their neighbors, and assign them as the observed location’s neighbors.</p>
</section>
<section id="bootstrap-simulations" class="level2">
<h2 class="anchored" data-anchor-id="bootstrap-simulations">Bootstrap simulations</h2>
<p>In sfdep, we use spdep’s <code>nb</code> object. These are lists that store the row position of the neighbors as integer vectors at each element.</p>
<blockquote class="blockquote">
<p>If you want to learn more about neighbors <a href="https://youtu.be/i_MA1U6SJ1Y?t=1301">I gave a talk</a> at NY Hackr MeetUp a few months ago that might help.</p>
</blockquote>
<p>Here I define a function that samples from the positions (<code>index</code>), then uses that sample to shuffle up the existing neighborhoods and return a shuffled <code>nb</code> object. Note that I add the <code>nb</code> class back to the list.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">bootstrap_nbs</span> <span class="o">&lt;-</span> <span class="kr">function</span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span> <span class="o">{</span>
  <span class="c"># create index</span>
  <span class="nv">index</span> <span class="o">&lt;-</span> <span class="m">1</span><span class="o">:</span><span class="nf"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span>
  <span class="c"># create a resampled index</span>
  <span class="nv">resampled_index</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="o">(</span><span class="nv">index</span>, replace <span class="o">=</span> <span class="kc">TRUE</span><span class="o">)</span>
  <span class="c"># shuffle the neighbors and reassign class</span>
  <span class="nf"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="o">(</span><span class="nv">nb</span><span class="o">[</span><span class="nv">resampled_index</span><span class="o">]</span>, class <span class="o">=</span> <span class="nf"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="o">(</span><span class="s">"nb"</span>, <span class="s">"list"</span><span class="o">)</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
<p>Let’s compare some observations</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">nb</span><span class="o">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="o">]</span>
<span class="c">#&gt; [[1]]</span>
<span class="c">#&gt; [1]  2 13 14</span>
<span class="c">#&gt; </span>
<span class="c">#&gt; [[2]]</span>
<span class="c">#&gt; [1]  1  3 13 14 15</span>
<span class="c">#&gt; </span>
<span class="c">#&gt; [[3]]</span>
<span class="c">#&gt; [1]  2  4 14 15 16</span>

<span class="nf">bootstrap_nbs</span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span><span class="o">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="o">]</span>
<span class="c">#&gt; [[1]]</span>
<span class="c">#&gt; [1]  1  3 13 14 15</span>
<span class="c">#&gt; </span>
<span class="c">#&gt; [[2]]</span>
<span class="c">#&gt; [1] 46 47 48 58 60 70 71 72</span>
<span class="c">#&gt; </span>
<span class="c">#&gt; [[3]]</span>
<span class="c">#&gt; [1]  8 10 20 21 22</span></code></pre>
</div>
<p>Here we can see the random pattern. Look’s like there is fair amount of clustering of like values.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">grid</span> |&gt; 
  <span class="nf"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="o">(</span>x <span class="o">=</span> <span class="nf">classInt</span><span class="nf">::</span><span class="nf"><a href="https://r-spatial.github.io/classInt/reference/classify_intervals.html">classify_intervals</a></span><span class="o">(</span><span class="nv">x</span>, <span class="m">7</span><span class="o">)</span><span class="o">)</span> |&gt; 
  <span class="nf"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="o">(</span><span class="nf"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="o">(</span>fill <span class="o">=</span> <span class="nv">x</span><span class="o">)</span><span class="o">)</span> <span class="o">+</span>
  <span class="nf"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="o">(</span>color <span class="o">=</span> <span class="kc">NA</span>, lwd <span class="o">=</span> <span class="m">0</span><span class="o">)</span> <span class="o">+</span>
  <span class="nf"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span><span class="o">(</span>type <span class="o">=</span> <span class="s">"div"</span>, palette <span class="o">=</span> <span class="m">5</span>, direction <span class="o">=</span> <span class="o">-</span><span class="m">1</span><span class="o">)</span> <span class="o">+</span>
  <span class="nf"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="o">(</span><span class="o">)</span> 
</code></pre>
<p><img src="figs/unnamed-chunk-8-1.png" width="700px" style="display: block; margin: auto;"></p>
</div>
<p>With the weights and the neighbors we can calculate the global Moran. I’ll refer to this as the “observed.” Store it into an object called <code>obs</code>. We’ll need this to calculate a simulated p-value later.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">obs</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://sfdep.josiahparry.com/reference/global_moran.html">global_moran</a></span><span class="o">(</span><span class="nv">x</span>, <span class="nv">nb</span>, <span class="nv">wt</span><span class="o">)</span>
<span class="nv">obs</span><span class="o">[[</span><span class="s">"I"</span><span class="o">]</span><span class="o">]</span>
<span class="c">#&gt; [1] 0.4956842</span></code></pre>
</div>
<p>0.5 is a fair amount of positive spatial autocorrelation indicating that like values tend to cluster. But is this due to random chance, or does it depend on where these locations are? Now that we have the observed value of Moran’s I, we can simulate the value under spatial randomness using the bootstrapped sampling. To do so, we bootstrap sample our neighbors, recalculate the weights and then the global Moran. Now, if you’ve read my <a href="https://sfdep.josiahparry.com/articles/conditional-permutation.html">vignette on conditional permutation</a>, you know what is coming next. We need to create a reference distribution of the global Moran under spatial randomness. To do that, we apply our boot strap <code>nsim</code> times and recalculate the global Moran with each new neighbor list. I love the function <a href="https://rdrr.io/r/base/lapply.html"><code>replicate()</code></a> for these purposes.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">nsim</span> <span class="o">=</span> <span class="m">499</span> </code></pre>
</div>
<blockquote class="blockquote">
<p><em>Also, a thing I’ve started doing is assigning scalars / constants with an equals sign because they typically end up becoming function arguments.</em></p>
</blockquote>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">reps</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="o">(</span>
  <span class="nv">nsim</span>, <span class="o">{</span>
    <span class="nv">nb_sim</span> <span class="o">&lt;-</span> <span class="nf">bootstrap_nbs</span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span>
    <span class="nv">wt_sim</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://sfdep.josiahparry.com/reference/st_weights.html">st_weights</a></span><span class="o">(</span><span class="nv">nb_sim</span><span class="o">)</span>
    <span class="nf"><a href="https://sfdep.josiahparry.com/reference/global_moran.html">global_moran</a></span><span class="o">(</span><span class="nv">x</span>, <span class="nv">nb_sim</span>, <span class="nv">wt_sim</span><span class="o">)</span><span class="o">[[</span><span class="s">"I"</span><span class="o">]</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">)</span>

<span class="nf"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="o">(</span><span class="nv">reps</span>, xlim <span class="o">=</span> <span class="nf"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="o">(</span><span class="nf"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="o">(</span><span class="nv">reps</span><span class="o">)</span>, <span class="nv">obs</span><span class="o">[[</span><span class="s">"I"</span><span class="o">]</span><span class="o">]</span><span class="o">)</span><span class="o">)</span>
<span class="nf"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="o">(</span>v <span class="o">=</span> <span class="nv">obs</span><span class="o">[[</span><span class="s">"I"</span><span class="o">]</span><span class="o">]</span>, lty <span class="o">=</span> <span class="m">2</span><span class="o">)</span>
</code></pre>
<p><img src="figs/unnamed-chunk-11-1.png" width="700px" style="display: block; margin: auto;"></p>
</div>
<section id="bootstrap-limitations" class="level3">
<h3 class="anchored" data-anchor-id="bootstrap-limitations">Bootstrap limitations</h3>
<p>That’s all well and good, but let’s look at this a bit more. Since we’re using the bootstrap approach, we’re limited in the number of unique combinations that are possible. Let’s try something. Let’s calculate the spatial lag <code>nsim</code> times and find the number of unique values that we get.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">lags</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="o">(</span>
  <span class="nv">nsim</span>, <span class="o">{</span>
    <span class="c"># resample the neighbors list</span>
    <span class="nv">nb_sim</span> <span class="o">&lt;-</span> <span class="nf">bootstrap_nbs</span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span>
    <span class="c"># recalculate the weights</span>
    <span class="nv">wt_sim</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://sfdep.josiahparry.com/reference/st_weights.html">st_weights</a></span><span class="o">(</span><span class="nv">nb_sim</span><span class="o">)</span>
    <span class="c"># calculate the lag</span>
    <span class="nf"><a href="https://sfdep.josiahparry.com/reference/st_lag.html">st_lag</a></span><span class="o">(</span><span class="nv">x</span>, <span class="nv">nb_sim</span>, <span class="nv">wt_sim</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">)</span>

<span class="c"># cast from matrix to vector</span>
<span class="nv">lags_vec</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="o">(</span><span class="nv">lags</span><span class="o">)</span>

<span class="c"># how many are there?</span>
<span class="nf"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="o">(</span><span class="nv">lags_vec</span><span class="o">)</span>
<span class="c">#&gt; [1] 71856</span>

<span class="c"># how many unique?</span>
<span class="nf"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="o">(</span><span class="nf"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="o">(</span><span class="nv">lags_vec</span><span class="o">)</span><span class="o">)</span>
<span class="c">#&gt; [1] 144</span></code></pre>
</div>
<p>See this? There are only 144 unique value! That isn’t much! Don’t believe me? Run <code>table(lags_vec)</code>. For each location there are only a limited number of combinations that can occur.</p>
</section>
</section>
<section id="conditional-permutation" class="level2">
<h2 class="anchored" data-anchor-id="conditional-permutation">Conditional Permutation</h2>
<p>Now, here is where I want to introduce what I view to be the superior alternative: conditional permutation. Conditional permutation was described by Luc Anselin in his seminal 1995 paper. The idea is that we hold an observation constant, then we randomly assign neighbors. This is like the bootstrap approach but instead of grabbing a random observation’s neighborhood we create a totally new one. We do this be assigning the neighbors randomly from all possible locations.</p>
<p>Let’s look at how we can program this. For each location we need to sample from an index that excludes the observation’s position. Further we need to ensure that there are the same number of neighbors in each location (cardinality).</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">permute_nb</span> <span class="o">&lt;-</span> <span class="kr">function</span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span> <span class="o">{</span>
  <span class="c"># first get the cardinality</span>
  <span class="nv">cards</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://sfdep.josiahparry.com/reference/st_cardinalties.html">st_cardinalties</a></span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span>
  <span class="c"># instantiate empty list to fill</span>
  <span class="nv">nb_perm</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="o">(</span>mode <span class="o">=</span> <span class="s">"list"</span>, length <span class="o">=</span> <span class="nf"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span><span class="o">)</span>
  
  <span class="c"># instantiate an index</span>
  <span class="nv">index</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span>
  
  <span class="c"># iterate through and full nb_perm</span>
  <span class="kr">for</span> <span class="o">(</span><span class="nv">i</span> <span class="kr">in</span> <span class="nv">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="c"># remove i from the index, then sample and assign</span>
    <span class="nv">nb_perm</span><span class="o">[[</span><span class="nv">i</span><span class="o">]</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="o">(</span><span class="nv">index</span><span class="o">[</span><span class="o">-</span><span class="nv">i</span><span class="o">]</span>, <span class="nv">cards</span><span class="o">[</span><span class="nv">i</span><span class="o">]</span><span class="o">)</span>
  <span class="o">}</span>
  
  <span class="nf"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="o">(</span><span class="nv">nb_perm</span>, class <span class="o">=</span> <span class="s">"nb"</span><span class="o">)</span>
<span class="o">}</span>


<span class="nv">nb</span><span class="o">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="o">]</span>
<span class="c">#&gt; [[1]]</span>
<span class="c">#&gt; [1]  2 13 14</span>
<span class="c">#&gt; </span>
<span class="c">#&gt; [[2]]</span>
<span class="c">#&gt; [1]  1  3 13 14 15</span>
<span class="c">#&gt; </span>
<span class="c">#&gt; [[3]]</span>
<span class="c">#&gt; [1]  2  4 14 15 16</span>
<span class="nf">permute_nb</span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span><span class="o">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="o">]</span>
<span class="c">#&gt; [[1]]</span>
<span class="c">#&gt; [1] 104  26  29</span>
<span class="c">#&gt; </span>
<span class="c">#&gt; [[2]]</span>
<span class="c">#&gt; [1]  96 144  60 123  54</span>
<span class="c">#&gt; </span>
<span class="c">#&gt; [[3]]</span>
<span class="c">#&gt; [1]  13 128  94  14  67</span></code></pre>
</div>
<p>Now, let’s repeat the same exercise using conditional permutation.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nv">lags2</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="o">(</span>
  <span class="nv">nsim</span>, <span class="o">{</span>
    <span class="nv">nb_perm</span> <span class="o">&lt;-</span> <span class="nf">permute_nb</span><span class="o">(</span><span class="nv">nb</span><span class="o">)</span>
    <span class="nf"><a href="https://sfdep.josiahparry.com/reference/st_lag.html">st_lag</a></span><span class="o">(</span><span class="nv">x</span>, <span class="nv">nb_perm</span>, <span class="nf"><a href="https://sfdep.josiahparry.com/reference/st_weights.html">st_weights</a></span><span class="o">(</span><span class="nv">nb_perm</span><span class="o">)</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">)</span>

<span class="nv">lags2_vec</span> <span class="o">&lt;-</span> <span class="nf"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="o">(</span><span class="nv">lags2</span><span class="o">)</span>
  
<span class="nf"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="o">(</span><span class="nf"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="o">(</span><span class="nv">lags2_vec</span><span class="o">)</span><span class="o">)</span>
<span class="c">#&gt; [1] 71853</span></code></pre>
</div>
<p>There are farrrrr more unique values. In fact, there is a unique value for each simulation - location pair. If we look at the histograms, the difference is even more stark. The conditional permutation approach actually begins to represent a real distribution.</p>
<div class="highlight">
<pre class="chroma"><code class="language-r" data-lang="r"><span class="nf"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="o">(</span>mfrow <span class="o">=</span> <span class="nf"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="o">(</span><span class="m">1</span>, <span class="m">2</span><span class="o">)</span><span class="o">)</span>
<span class="nf"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="o">(</span><span class="nv">lags_vec</span>, breaks <span class="o">=</span> <span class="m">20</span><span class="o">)</span> 
<span class="nf"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="o">(</span><span class="nv">lags2_vec</span>, breaks <span class="o">=</span> <span class="m">20</span><span class="o">)</span>
</code></pre>
<p><img src="figs/unnamed-chunk-15-1.png" width="700px" style="display: block; margin: auto;"></p>
</div>
<p>So, this is all for me to say that bootstrapping isn’t it for creating simulated distributions for which to calculate your p-values.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="josiahparry/quarto-site" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>